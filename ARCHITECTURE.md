# Архитектура Task Manager PWA

Документ описывает текущую организацию клиентского Flutter-приложения Task Manager, его основные слои и последовательность взаимодействия между ними.

## Структурные слои

### Presentation (UI)
- **AuthWrapper** — корневой `StatefulWidget`, назначенный в `MaterialApp.home`. Асинхронно проверяет наличие и валидность токена перед показом главного интерфейса.
- **LoginScreen** — форма авторизации с переключателем email/username, валидацией полей и переходом к настройкам сервера.
- **HomeScreen** — приветствие пользователя, карточки статистики-заглушки и быстрые действия с возможностью выхода из аккаунта.
- **SettingsScreen** — ввод и сохранение URL сервера с визуальными уведомлениями об успехе/ошибке.

### Services
- **AuthService** — обертка над HTTP-запросами входа и выхода, управление токеном Knox, проверка срока действия (`auth_expiry`) и доступ к данным пользователя.
- **SettingsService** — взаимодействие с `FlutterSecureStorage` для сохранения базового адреса сервера, валидация URL и построение полного пути `/api/`.

### Data & Storage
- **User** — неизменяемая модель пользователя с методами `fromJson`, `toJson`, `copyWith` и переопределениями `==`/`hashCode`.
- **FlutterSecureStorage** — единая точка хранения токена, даты истечения, данных пользователя и выбранного серверного URL. На веб-платформе использует fallback-хранилище, предоставляемое пакетом.

### Темизация
- **AppColors** — палитра для светлой и тёмной тем, включая фоновые, текстовые и статусные цвета.
- **AppTheme** — фабрики `ThemeData` для Material 3: определяют AppBar, Card, InputDecoration и стили кнопок в обоих режимах.

## Последовательность запуска

1. `TaskManagerApp` создаёт `MaterialApp` с темами и маршрутами (`/login`, `/home`, `/settings`).
2. `AuthWrapper` вызывает `AuthService.isAuthenticated()`:
   - считывает токен и дату истечения из хранилища;
   - очищает данные и возвращает `false`, если срок действия истёк или чтение завершилось ошибкой.
3. В зависимости от результата показывается `HomeScreen` (действительный токен) или `LoginScreen` (гость).

## Поток авторизации

1. Пользователь вводит имя пользователя или email и пароль на `LoginScreen`.
2. После успешной валидации вызывается `AuthService.login()`:
   - `SettingsService.getApiBaseUrl()` возвращает базовый URL с добавленным суффиксом `/api/`;
   - формируется запрос `POST {apiBaseUrl}auth/login/` с JSON-телом;
   - при ответе 200 сохраняются токен, дата истечения и данные пользователя в `FlutterSecureStorage`.
3. Навигация переключается на `HomeScreen`, который извлекает пользователя через `AuthService.getCurrentUser()` и отображает карточки статистики.
4. При выборе действия «Выйти» вызывается `AuthService.logout()` — он отправляет запрос на `${apiBaseUrl}auth/logout/`, очищает хранилище и возвращает пользователя на `LoginScreen`.

## Работа с настройками сервера

- `SettingsScreen` загружает сохранённый URL при инициализации через `SettingsService.getServerUrl()`.
- Валидация гарантирует наличие схемы `http://` или `https://` и корректного URI.
- После сохранения значение используется всеми дальнейшими сетевыми запросами и переживает перезапуски приложения.

## Точки расширения

- Добавление экранов задач и профиля может опираться на существующую систему маршрутов и хранение токена.
- Для интеграции с реальными данными задач можно дополнить `AuthService` отдельными сервисами или вынести сетевую работу в слой репозиториев.
- PWA-специфику (оффлайн-режим, пуш-уведомления) рекомендуется развивать через сервис-воркеры и Web Push, не затрагивая существующий UI слой.
